<html ng-app="morseApp">
    <head>
        <title>Cheap Morse</title>
        <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.6.7/angular.min.js"></script>
        <!-- <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.6.7/angular-touch.js"></script> -->
        <!-- (from: https://stackoverflow.com/a/10614533/2885946) -->
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    </head>
    
    <style>
        .morse_button{
            width: 100%;
            height: 100px;
            display: block;
            background: #ccc;
            font-size: 3em;
            /* (from: https://stackoverflow.com/a/923804/2885946) */
            -webkit-user-select: none; 
        }

        .morse_input{
            font-weight: bold;
            font-size: 50px;
        }
    </style>
    <script>
            angular.module('morseApp', [])
                .controller('morseCtrl', ['$scope', '$timeout', ($scope, $timeout) => {
                    $scope.long_threshold  = 250;
                    $scope.word_threshold = 1000;
                    $scope.signal = "";
                    $scope.input   = "";
                    $scope.isTouchMode = true;
                    $scope.isDebugMode = false;
                    $scope.debugLogs = [];

                    let timeoutId = null;
                    
                    let startDate = new Date();

                    const signalToChar = {
                        ".-"     : "a",
                        "-..."   : "b",
                        "-.-."   : "c",
                        "-.."    : "d",
                        "."      : "e",
                        "..-."   : "f",
                        "--."    : "g",
                        "...."   : "h",
                        ".."     : "i",
                        ".---"   : "j",
                        "-.-"    : "k",
                        ".-.."   : "l",
                        "--"     : "m",
                        "-."     : "n",
                        "---"    : "o",
                        ".--."   : "p",
                        "--.-"   : "q",
                        ".-."    : "r",
                        "..."    : "s",
                        "-"      : "t",
                        "..-"    : "u",
                        "...-"   : "v",
                        ".--"    : "w",
                        "-..-"   : "x",
                        "-.--"   : "y",
                        "--.."   : "z",
                        "-----"  : "0",
                        ".----"  : "1",
                        "..---"  : "2",
                        "...--"  : "3",
                        "....-"  : "4",
                        "....."  : "5",
                        "-...."  : "6",
                        "--..."  : "7",
                        "---.."  : "8",
                        "----."  : "9",
                        ".-.-.-" : ".",
                        "--..--" : ",",
                        "---..." : ":",
                        "..--.." : "?",
                        ".----." : "'",
                        "-....-" : "-",
                        "-..-."  : "/",
                        "-.--.-" : "(",
                        //            "-.--.-" : ")",
                        ".-..-." : "\"",
                        ".--.-." : "@",
                        "-...-"  : "=",
                        "-.-.--" : "!"
                    }
                    
                    $scope.mouseup = (e) => {
                        console.log('mouse up');
                        $scope.debugLogs.push(`mouse up: ${e}`);
                        
                        const passedMilli = new Date() - startDate;
                        console.log(passedMilli);

                        if (passedMilli <= $scope.long_threshold){
                            $scope.signal += '.';
                        } else if (passedMilli <= $scope.word_threshold) {
                            $scope.signal += '-';
                        }

                        timeoutId = $timeout(() => {
                            console.log('WORD END!');
                            $scope.debugLogs.push("world end");                        
                            if ($scope.signal in signalToChar){
                                $scope.input += signalToChar[$scope.signal];
                            } else {
                                $scope.input += "[?]"
                            }
                            
                            timeoutId = null;
                            $scope.signal = "";

                        }, $scope.word_threshold)

                    };

                    $scope.mousedown = (e) => {
                        console.log(`mouse down: ${e}`);
                        $scope.debugLogs.push(`mouse down: ${e}`);
                        startDate = new Date();

                        if (timeoutId != null) {
                            $timeout.cancel(timeoutId)
                        }

                    };

                    // $scope.morseSignal = () => {
                    //     return $scope.signals.join('')
                    // };

                    $scope.clearInput = () => {
                        $scope.input = "";
                    }
                }])
                // (from: https://st40.xyz/one-run/article/116/)
                .directive('myTouchstart', [function() {
                    return function(scope, element, attr) {
                
                        element.on('touchstart', function(event) {
                            scope.$apply(function() { 
                                scope.$eval(attr.myTouchstart); 
                            });
                        });
                    };
                }]).directive('myTouchend', [function() {
                    return function(scope, element, attr) {
                
                        element.on('touchend', function(event) {
                            scope.$apply(function() { 
                                scope.$eval(attr.myTouchend); 
                            });
                        });
                    };
                }]);
            </script>

    <body>
        <div ng-controller="morseCtrl">
            <a ng-if='isTouchMode' my-touchstart='mousedown($event)' my-touchend='mouseup($event)' class='morse_button'></a><br>
            <a ng-if='!isTouchMode' ng-mousedown='mousedown($event)' ng-mouseup='mouseup($event)' class='morse_button'></a><br>
            long_threshold:<input type="number" ng-model="long_threshold"><br>
            word threshold:<input type="number" ng-model="word_threshold"><br>
            Touch mode: <input type="checkbox" ng-model="isTouchMode"><br>            
            Debug mode: <input type="checkbox" ng-model="isDebugMode"><br>
            <button ng-click='clearInput()'>Clear input</button><br>
            <div class='morse_input'>{{input}}</div> 
            <div class='morse_input'>{{signal}}</div>
            <ul ng-show="isDebugMode">
                <li ng-repeat="debugLog in debugLogs track by $index">{{debugLog}}</li>
            <ul>
        </div>
    </body>
</html>